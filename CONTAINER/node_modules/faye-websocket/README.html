<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="faye-websocket-build-status">faye-websocket <a href="http://travis-ci.org/faye/faye-websocket-node"><img src="https://secure.travis-ci.org/faye/faye-websocket-node.svg" alt="Build status" /></a></h1>
<p>This is a general-purpose WebSocket implementation extracted from the <a href="http://faye.jcoglan.com">Faye</a> project. It provides classes for easily building WebSocket servers and clients in Node. It does not provide a server itself, but rather makes it easy to handle WebSocket connections within an existing <a href="https://nodejs.org/">Node</a> application. It does not provide any abstraction other than the standard <a href="https://html.spec.whatwg.org/multipage/comms.html#network">WebSocket API</a>.</p>
<p>It also provides an abstraction for handling <a href="https://html.spec.whatwg.org/multipage/comms.html#server-sent-events">EventSource</a> connections, which are one-way connections that allow the server to push data to the client. They are based on streaming HTTP responses and can be easier to access via proxies than WebSockets.</p>
<h2 id="installation">Installation</h2>
<pre><code>$ npm install faye-websocket</code></pre>
<h2 id="handling-websocket-connections-in-node">Handling WebSocket connections in Node</h2>
<p>You can handle WebSockets on the server side by listening for HTTP Upgrade requests, and creating a new socket for the request. This socket object exposes the usual WebSocket methods for receiving and sending messages. For example this is how you’d implement an echo server:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">var</span> WebSocket <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;faye-websocket&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb2-2" title="2">    http      <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;http&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">var</span> server <span class="op">=</span> <span class="va">http</span>.<span class="at">createServer</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="va">server</span>.<span class="at">on</span>(<span class="st">&#39;upgrade&#39;</span><span class="op">,</span> <span class="kw">function</span>(request<span class="op">,</span> socket<span class="op">,</span> body) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-7" title="7">  <span class="cf">if</span> (<span class="va">WebSocket</span>.<span class="at">isWebSocket</span>(request)) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="kw">var</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(request<span class="op">,</span> socket<span class="op">,</span> body)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-9" title="9">    </a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="va">ws</span>.<span class="at">on</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> <span class="kw">function</span>(event) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-11" title="11">      <span class="va">ws</span>.<span class="at">send</span>(<span class="va">event</span>.<span class="at">data</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-13" title="13">    </a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="va">ws</span>.<span class="at">on</span>(<span class="st">&#39;close&#39;</span><span class="op">,</span> <span class="kw">function</span>(event) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-15" title="15">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;close&#39;</span><span class="op">,</span> <span class="va">event</span>.<span class="at">code</span><span class="op">,</span> <span class="va">event</span>.<span class="at">reason</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-16" title="16">      ws <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-17" title="17">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-18" title="18">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-20" title="20"></a>
<a class="sourceLine" id="cb2-21" title="21"><span class="va">server</span>.<span class="at">listen</span>(<span class="dv">8000</span>)<span class="op">;</span></a></code></pre></div>
<p><code>WebSocket</code> objects are also duplex streams, so you could replace the <code>ws.on('message', ...)</code> line with:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1">    <span class="va">ws</span>.<span class="at">pipe</span>(ws)<span class="op">;</span></a></code></pre></div>
<p>Note that under certain circumstances (notably a draft-76 client connecting through an HTTP proxy), the WebSocket handshake will not be complete after you call <code>new WebSocket()</code> because the server will not have received the entire handshake from the client yet. In this case, calls to <code>ws.send()</code> will buffer the message in memory until the handshake is complete, at which point any buffered messages will be sent to the client.</p>
<p>If you need to detect when the WebSocket handshake is complete, you can use the <code>onopen</code> event.</p>
<p>If the connection’s protocol version supports it, you can call <code>ws.ping()</code> to send a ping message and wait for the client’s response. This method takes a message string, and an optional callback that fires when a matching pong message is received. It returns <code>true</code> if and only if a ping message was sent. If the client does not support ping/pong, this method sends no data and returns <code>false</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="va">ws</span>.<span class="at">ping</span>(<span class="st">&#39;Mic check, one, two&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="co">// fires when pong is received</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="using-the-websocket-client">Using the WebSocket client</h2>
<p>The client supports both the plain-text <code>ws</code> protocol and the encrypted <code>wss</code> protocol, and has exactly the same interface as a socket you would use in a web browser. On the wire it identifies itself as <code>hybi-13</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">var</span> WebSocket <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;faye-websocket&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb5-2" title="2">    ws        <span class="op">=</span> <span class="kw">new</span> <span class="va">WebSocket</span>.<span class="at">Client</span>(<span class="st">&#39;ws://www.example.com/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="va">ws</span>.<span class="at">on</span>(<span class="st">&#39;open&#39;</span><span class="op">,</span> <span class="kw">function</span>(event) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="va">ws</span>.<span class="at">send</span>(<span class="st">&#39;Hello, world!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="va">ws</span>.<span class="at">on</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> <span class="kw">function</span>(event) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> <span class="va">event</span>.<span class="at">data</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-11" title="11"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-12" title="12"></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="va">ws</span>.<span class="at">on</span>(<span class="st">&#39;close&#39;</span><span class="op">,</span> <span class="kw">function</span>(event) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;close&#39;</span><span class="op">,</span> <span class="va">event</span>.<span class="at">code</span><span class="op">,</span> <span class="va">event</span>.<span class="at">reason</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-15" title="15">  ws <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-16" title="16"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The WebSocket client also lets you inspect the status and headers of the handshake response via its <code>statusCode</code> and <code>headers</code> properties.</p>
<p>To connect via a proxy, set the <code>proxy</code> option to the HTTP origin of the proxy, including any authorization information, custom headers and TLS config you require. Only the <code>origin</code> setting is required.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">var</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="va">WebSocket</span>.<span class="at">Client</span>(<span class="st">&#39;ws://www.example.com/&#39;</span><span class="op">,</span> []<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="dt">proxy</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="dt">origin</span><span class="op">:</span>  <span class="st">&#39;http://username:password@proxy.example.com&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span><span class="st">&#39;User-Agent&#39;</span><span class="op">:</span> <span class="st">&#39;node&#39;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb6-5" title="5">    <span class="dt">tls</span><span class="op">:</span>     <span class="op">{</span><span class="dt">cert</span><span class="op">:</span> <span class="va">fs</span>.<span class="at">readFileSync</span>(<span class="st">&#39;client.crt&#39;</span>)<span class="op">}</span></a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The <code>tls</code> value is an object that will be passed to <a href="https://nodejs.org/api/tls.html#tls_tls_connect_options_callback"><code>tls.connect()</code></a>.</p>
<h2 id="subprotocol-negotiation">Subprotocol negotiation</h2>
<p>The WebSocket protocol allows peers to select and identify the application protocol to use over the connection. On the client side, you can set which protocols the client accepts by passing a list of protocol names when you construct the socket:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">var</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="va">WebSocket</span>.<span class="at">Client</span>(<span class="st">&#39;ws://www.example.com/&#39;</span><span class="op">,</span> [<span class="st">&#39;irc&#39;</span><span class="op">,</span> <span class="st">&#39;amqp&#39;</span>])<span class="op">;</span></a></code></pre></div>
<p>On the server side, you can likewise pass in the list of protocols the server supports after the other constructor arguments:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">var</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(request<span class="op">,</span> socket<span class="op">,</span> body<span class="op">,</span> [<span class="st">&#39;irc&#39;</span><span class="op">,</span> <span class="st">&#39;amqp&#39;</span>])<span class="op">;</span></a></code></pre></div>
<p>If the client and server agree on a protocol, both the client- and server-side socket objects expose the selected protocol through the <code>ws.protocol</code> property.</p>
<h2 id="protocol-extensions">Protocol extensions</h2>
<p>faye-websocket is based on the <a href="https://github.com/faye/websocket-extensions-node">websocket-extensions</a> framework that allows extensions to be negotiated via the <code>Sec-WebSocket-Extensions</code> header. To add extensions to a connection, pass an array of extensions to the <code>:extensions</code> option. For example, to add <a href="https://github.com/faye/permessage-deflate-node">permessage-deflate</a>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">var</span> deflate <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;permessage-deflate&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-2" title="2"></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="kw">var</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(request<span class="op">,</span> socket<span class="op">,</span> body<span class="op">,</span> []<span class="op">,</span> <span class="op">{</span><span class="dt">extensions</span><span class="op">:</span> [deflate]<span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="initialization-options">Initialization options</h2>
<p>Both the server- and client-side classes allow an options object to be passed in at initialization time, for example:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">var</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(request<span class="op">,</span> socket<span class="op">,</span> body<span class="op">,</span> protocols<span class="op">,</span> options)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">var</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="va">WebSocket</span>.<span class="at">Client</span>(url<span class="op">,</span> protocols<span class="op">,</span> options)<span class="op">;</span></a></code></pre></div>
<p><code>protocols</code> is an array of subprotocols as described above, or <code>null</code>. <code>options</code> is an optional object containing any of these fields:</p>
<ul>
<li><code>extensions</code> - an array of <a href="https://github.com/faye/websocket-extensions-node">websocket-extensions</a> compatible extensions, as described above</li>
<li><code>headers</code> - an object containing key-value pairs representing HTTP headers to be sent during the handshake process</li>
<li><code>maxLength</code> - the maximum allowed size of incoming message frames, in bytes. The default value is <code>2^26 - 1</code>, or 1 byte short of 64 MiB.</li>
<li><code>ping</code> - an integer that sets how often the WebSocket should send ping frames, measured in seconds</li>
</ul>
<p>The client accepts some additional options:</p>
<ul>
<li><code>proxy</code> - settings for a proxy as described above</li>
<li><code>net</code> - an object containing settings for the origin server that will be passed to <a href="https://nodejs.org/api/net.html#net_socket_connect_options_connectlistener"><code>net.connect()</code></a></li>
<li><code>tls</code> - an object containing TLS settings for the origin server, this will be passed to <a href="https://nodejs.org/api/tls.html#tls_tls_connect_options_callback"><code>tls.connect()</code></a></li>
<li><code>ca</code> - (legacy) a shorthand for passing <code>{tls: {ca: value}}</code></li>
</ul>
<h2 id="websocket-api">WebSocket API</h2>
<p>Both server- and client-side <code>WebSocket</code> objects support the following API.</p>
<ul>
<li><strong><code>on('open', function(event) {})</code></strong> fires when the socket connection is established. Event has no attributes.</li>
<li><strong><code>on('message', function(event) {})</code></strong> fires when the socket receives a message. Event has one attribute, <strong><code>data</code></strong>, which is either a <code>String</code> (for text frames) or a <code>Buffer</code> (for binary frames).</li>
<li><strong><code>on('error', function(event) {})</code></strong> fires when there is a protocol error due to bad data sent by the other peer. This event is purely informational, you do not need to implement error recover.</li>
<li><strong><code>on('close', function(event) {})</code></strong> fires when either the client or the server closes the connection. Event has two optional attributes, <strong><code>code</code></strong> and <strong><code>reason</code></strong>, that expose the status code and message sent by the peer that closed the connection.</li>
<li><strong><code>send(message)</code></strong> accepts either a <code>String</code> or a <code>Buffer</code> and sends a text or binary message over the connection to the other peer.</li>
<li><strong><code>ping(message, function() {})</code></strong> sends a ping frame with an optional message and fires the callback when a matching pong is received.</li>
<li><strong><code>close(code, reason)</code></strong> closes the connection, sending the given status code and reason text, both of which are optional.</li>
<li><strong><code>version</code></strong> is a string containing the version of the <code>WebSocket</code> protocol the connection is using.</li>
<li><strong><code>protocol</code></strong> is a string (which may be empty) identifying the subprotocol the socket is using.</li>
</ul>
<h2 id="handling-eventsource-connections-in-node">Handling EventSource connections in Node</h2>
<p>EventSource connections provide a very similar interface, although because they only allow the server to send data to the client, there is no <code>onmessage</code> API. EventSource allows the server to push text messages to the client, where each message has an optional event-type and ID.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">var</span> WebSocket   <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;faye-websocket&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb11-2" title="2">    EventSource <span class="op">=</span> <span class="va">WebSocket</span>.<span class="at">EventSource</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-3" title="3">    http        <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;http&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="kw">var</span> server <span class="op">=</span> <span class="va">http</span>.<span class="at">createServer</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-6" title="6"></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="va">server</span>.<span class="at">on</span>(<span class="st">&#39;request&#39;</span><span class="op">,</span> <span class="kw">function</span>(request<span class="op">,</span> response) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-8" title="8">  <span class="cf">if</span> (<span class="va">EventSource</span>.<span class="at">isEventSource</span>(request)) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-9" title="9">    <span class="kw">var</span> es <span class="op">=</span> <span class="kw">new</span> <span class="at">EventSource</span>(request<span class="op">,</span> response)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-10" title="10">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;open&#39;</span><span class="op">,</span> <span class="va">es</span>.<span class="at">url</span><span class="op">,</span> <span class="va">es</span>.<span class="at">lastEventId</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-11" title="11">    </a>
<a class="sourceLine" id="cb11-12" title="12">    <span class="co">// Periodically send messages</span></a>
<a class="sourceLine" id="cb11-13" title="13">    <span class="kw">var</span> loop <span class="op">=</span> <span class="at">setInterval</span>(<span class="kw">function</span>() <span class="op">{</span> <span class="va">es</span>.<span class="at">send</span>(<span class="st">&#39;Hello&#39;</span>) <span class="op">},</span> <span class="dv">1000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-14" title="14">    </a>
<a class="sourceLine" id="cb11-15" title="15">    <span class="va">es</span>.<span class="at">on</span>(<span class="st">&#39;close&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-16" title="16">      <span class="at">clearInterval</span>(loop)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-17" title="17">      es <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-18" title="18">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-19" title="19">  </a>
<a class="sourceLine" id="cb11-20" title="20">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-21" title="21">    <span class="co">// Normal HTTP request</span></a>
<a class="sourceLine" id="cb11-22" title="22">    <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">200</span><span class="op">,</span> <span class="op">{</span><span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;text/plain&#39;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-23" title="23">    <span class="va">response</span>.<span class="at">end</span>(<span class="st">&#39;Hello&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-24" title="24">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-25" title="25"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-26" title="26"></a>
<a class="sourceLine" id="cb11-27" title="27"><span class="va">server</span>.<span class="at">listen</span>(<span class="dv">8000</span>)<span class="op">;</span></a></code></pre></div>
<p>The <code>send</code> method takes two optional parameters, <code>event</code> and <code>id</code>. The default event-type is <code>'message'</code> with no ID. For example, to send a <code>notification</code> event with ID <code>99</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="va">es</span>.<span class="at">send</span>(<span class="st">&#39;Breaking News!&#39;</span><span class="op">,</span> <span class="op">{</span><span class="dt">event</span><span class="op">:</span> <span class="st">&#39;notification&#39;</span><span class="op">,</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;99&#39;</span><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The <code>EventSource</code> object exposes the following properties:</p>
<ul>
<li><strong><code>url</code></strong> is a string containing the URL the client used to create the EventSource.</li>
<li><strong><code>lastEventId</code></strong> is a string containing the last event ID received by the client. You can use this when the client reconnects after a dropped connection to determine which messages need resending.</li>
</ul>
<p>When you initialize an EventSource with <code>new EventSource()</code>, you can pass configuration options after the <code>response</code> parameter. Available options are:</p>
<ul>
<li><strong><code>headers</code></strong> is an object containing custom headers to be set on the EventSource response.</li>
<li><strong><code>retry</code></strong> is a number that tells the client how long (in seconds) it should wait after a dropped connection before attempting to reconnect.</li>
<li><strong><code>ping</code></strong> is a number that tells the server how often (in seconds) to send ‘ping’ packets to the client to keep the connection open, to defeat timeouts set by proxies. The client will ignore these messages.</li>
</ul>
<p>For example, this creates a connection that allows access from any origin, pings every 15 seconds and is retryable every 10 seconds if the connection is broken:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">var</span> es <span class="op">=</span> <span class="kw">new</span> <span class="at">EventSource</span>(request<span class="op">,</span> response<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span><span class="st">&#39;Access-Control-Allow-Origin&#39;</span><span class="op">:</span> <span class="st">&#39;*&#39;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb13-3" title="3">  <span class="dt">ping</span><span class="op">:</span>    <span class="dv">15</span><span class="op">,</span></a>
<a class="sourceLine" id="cb13-4" title="4">  <span class="dt">retry</span><span class="op">:</span>   <span class="dv">10</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>You can send a ping message at any time by calling <code>es.ping()</code>. Unlike WebSocket, the client does not send a response to this; it is merely to send some data over the wire to keep the connection alive.</p>
</body>
</html>
